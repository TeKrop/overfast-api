name: "Sync Upstream & Deploy"

permissions:
  contents: write

on:
  schedule:
    # Run daily at 6:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "Force deployment even if no updates"
        required: false
        default: false
        type: boolean

jobs:
  sync:
    name: Sync with upstream
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.sync.outputs.has_updates }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Configure merge drivers
        run: |
          # "accept-upstream" driver: replaces our file with upstream's version
          git config merge.accept-upstream.name "Accept upstream version"
          git config merge.accept-upstream.driver "cp '%B' '%A'"

          # "keep-fork" driver: keeps our fork version unchanged
          git config merge.keep-fork.name "Keep fork version"
          git config merge.keep-fork.driver true

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/TeKrop/overfast-api.git || true
          git fetch upstream

      - name: Check for updates and sync
        id: sync
        run: |
          set -euo pipefail

          # Determine upstream default branch dynamically (usually main).
          # Fallback to "main" if detection fails for safety.
          UPSTREAM_BRANCH="$(git symbolic-ref --short refs/remotes/upstream/HEAD | sed 's@^upstream/@@' || true)"
          if [ -z "$UPSTREAM_BRANCH" ]; then
            UPSTREAM_BRANCH="main"
          fi
          UPSTREAM_REF="upstream/${UPSTREAM_BRANCH}"

          # Get current and upstream commits
          CURRENT=$(git rev-parse HEAD)
          UPSTREAM=$(git rev-parse "$UPSTREAM_REF")

          echo "Current: $CURRENT"
          echo "Upstream: $UPSTREAM"

          # Check if there are new commits
          NEW_COMMITS=$(git log HEAD.."$UPSTREAM_REF" --oneline)

          if [ -n "$NEW_COMMITS" ]; then
            echo "New commits found:"
            echo "$NEW_COMMITS"

            # Merge upstream - .gitattributes merge drivers handle conflict resolution:
            # - CHANGELOG.md: accepts upstream version (accept-upstream driver)
            # - Fork-specific files (nginx, README, etc.): keeps fork version (keep-fork driver)
            if ! git merge "$UPSTREAM_REF" -m "Merge upstream changes"; then
              echo "Merge conflict detected, attempting automatic resolution..."

              # List any remaining conflicted files not covered by .gitattributes
              CONFLICTED=$(git diff --name-only --diff-filter=U)

              if [ -n "$CONFLICTED" ]; then
                echo "Conflicted files: $CONFLICTED"

                for file in $CONFLICTED; do
                  echo "Resolving $file with upstream version"
                  git checkout --theirs "$file"
                  git add "$file"
                done

                git commit -m "Merge upstream changes (auto-resolved conflicts)"
              else
                echo "All conflicts resolved by merge drivers"
                git commit -m "Merge upstream changes"
              fi
            fi

            # Push to origin
            git push origin "HEAD:${UPSTREAM_BRANCH}"

            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "No new commits from upstream"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to VPS
    needs: sync
    runs-on: ubuntu-latest
    if: needs.sync.outputs.has_updates == 'true' || github.event.inputs.force_deploy == 'true'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          port: ${{ secrets.VPS_PORT }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            /opt/deploy-overfast.sh

  notify:
    name: Send notification
    needs: [sync, deploy]
    runs-on: ubuntu-latest
    if: always() && needs.sync.outputs.has_updates == 'true'

    steps:
      - name: Notify app repo of API update
        if: needs.deploy.result == 'success'
        env:
          GH_TOKEN: ${{ secrets.APP_REPO_PAT }}
        run: |
          gh api \
            repos/danielsogl/overwatch_app/dispatches \
            -f event_type=api-updated

      - name: Notify on failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "Deployment failed!"
          # Add notification logic here
